<?xml version='1.0' standalone='yes'?>

<!DOCTYPE PLUGIN [
<!ENTITY name      "openclaw-connect">
<!ENTITY author    "emaspa">
<!ENTITY version   "2026.02.28.3">
<!ENTITY launch    "Settings/openclaw-connect">
<!ENTITY repo      "emaspa/unraidclaw">
<!ENTITY pluginURL "https://raw.githubusercontent.com/&repo;/main/packages/unraid-plugin/openclaw-connect.plg">
<!ENTITY pkgURL    "https://github.com/&repo;/releases/download/v&version;/&name;-&version;-x86_64-1.txz">
<!ENTITY md5       "ce1d0fb6d657681b2fda926446a5921f">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.12.0" max="7.99.99">

<CHANGES>
### &version;
- Fix API key generation (empty response issue)
- Improved error reporting in key generation UI
- Dark theme CSS fixes with explicit light text colors
- Added back navigation links on all sub-pages
- Node.js path detection for Unraid 7.x (/usr/local/bin/node)

### 2026.02.28
- Initial release
- REST API gateway for AI agents (OpenClaw)
- Full permission matrix with WebGUI management
- Docker, VM, Array, System, Shares, Notifications, Network management
- SHA-256 API key authentication
- Activity logging with JSONL format
</CHANGES>

<!-- Check for Node.js 22+ -->
<FILE Run="/bin/bash">
<INLINE>
#!/bin/bash
# Check if Node.js is available (check multiple common paths)
NODE_BIN=""
for p in /usr/local/bin/node /usr/bin/node; do
  if [ -x "$p" ]; then
    NODE_BIN="$p"
    break
  fi
done
if [ -z "$NODE_BIN" ]; then
  NODE_BIN=$(which node 2>/dev/null || true)
fi
NODE_VERSION=$($NODE_BIN --version 2>/dev/null | sed 's/v//')
if [ -z "$NODE_VERSION" ]; then
  echo "ERROR: Node.js is not installed."
  echo "For Unraid 6.x, install Node.js via NerdPack."
  echo "Unraid 7.x should have Node.js built-in."
  echo "Searched: /usr/local/bin/node, /usr/bin/node, PATH"
  exit 1
fi

NODE_MAJOR=$(echo "$NODE_VERSION" | cut -d. -f1)
if [ "$NODE_MAJOR" -lt 22 ]; then
  echo "WARNING: Node.js v${NODE_VERSION} detected. v22+ recommended."
  echo "Some features may not work correctly."
fi
echo "Node.js v${NODE_VERSION} detected. OK."
</INLINE>
</FILE>

<!-- Download and install the package -->
<FILE Name="/boot/config/plugins/&name;/&name;-&version;-x86_64-1.txz" Run="upgradepkg --install-new">
<URL>&pkgURL;</URL>
<MD5>&md5;</MD5>
</FILE>

<!-- Create default config if not present -->
<FILE Name="/boot/config/plugins/&name;/openclaw-connect.cfg">
<INLINE>
<![CDATA[
SERVICE="disable"
PORT="9876"
HOST="0.0.0.0"
API_KEY_HASH=""
GRAPHQL_URL="http://localhost/graphql"
UNRAID_API_KEY=""
LOG_FILE="/boot/config/plugins/openclaw-connect/activity.jsonl"
MAX_LOG_SIZE="10485760"
]]>
</INLINE>
</FILE>

<!-- Create default permissions if not present -->
<FILE Name="/boot/config/plugins/&name;/permissions.json">
<INLINE>
<![CDATA[
{}
]]>
</INLINE>
</FILE>

<!-- Post-install: set permissions and optionally start service -->
<FILE Run="/bin/bash">
<INLINE>
#!/bin/bash
PLUGIN="&name;"

# Make scripts executable
chmod +x /etc/rc.d/rc.${PLUGIN} 2>/dev/null
chmod +x /usr/local/emhttp/plugins/${PLUGIN}/event/* 2>/dev/null

# Auto-start if enabled
CONFIG="/boot/config/plugins/${PLUGIN}/openclaw-connect.cfg"
if [ -f "$CONFIG" ]; then
  SERVICE=$(grep -oP 'SERVICE="\K[^"]+' "$CONFIG")
  if [ "$SERVICE" = "enable" ]; then
    /etc/rc.d/rc.${PLUGIN} start
  fi
fi

echo "&name; v&version; installed."
</INLINE>
</FILE>

<!-- Uninstall -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
#!/bin/bash
PLUGIN="&name;"

# Stop service
/etc/rc.d/rc.${PLUGIN} stop 2>/dev/null

# Remove package
removepkg ${PLUGIN}-&version;-x86_64-1 2>/dev/null

# Remove plugin files (keep config on flash for re-install)
rm -rf /usr/local/emhttp/plugins/${PLUGIN}
rm -f /etc/rc.d/rc.${PLUGIN}

echo "&name; removed."
echo "Config files preserved in /boot/config/plugins/${PLUGIN}/"
echo "To fully remove, delete /boot/config/plugins/${PLUGIN}/ manually."
</INLINE>
</FILE>

</PLUGIN>
